## Spring Security

authenticationì„ securityì— ë‹´ì•„ì•¼í•¨

authentication ê°ì²´ ë§Œë“¤ë ¤ë©´ userdetail ê°ì²´ê°€ í•„ìš”í•˜ë‹¤

 userdetail ì€ userdetailserviceì—ì„œ ì˜´

ğŸ” ìˆœì„œ ì •ë¦¬ (í•œ ë¬¸ì¥ì”©)

1. `UserDetailsService`ì—ì„œ `UserDetails` ê°ì²´ë¥¼ ë§Œë“ ë‹¤.
2. `UserDetails`ëŠ” ì¸ì¦ ì²˜ë¦¬ì— ì‚¬ìš©ëœë‹¤.
3. ì¸ì¦ì— ì„±ê³µí•˜ë©´ `Authentication` ê°ì²´ê°€ ë§Œë“¤ì–´ì§„ë‹¤.
4. ì´ `Authentication` ê°ì²´ëŠ” `SecurityContext`ì— ì €ì¥ëœë‹¤.
5. ì´í›„ ìš”ì²­ë§ˆë‹¤ Securityê°€ ì´ ê°ì²´ë¥¼ ì°¸ì¡°í•˜ì—¬ ì¸ì¦/ì¸ê°€ë¥¼ ìˆ˜í–‰í•œë‹¤.

```java
<dependency>
            <groupId>org.apache.tomcat.embed</groupId>
            <artifactId>tomcat-embed-jasper</artifactId>
            <version>10.1.19</version>
        </dependency>
```

src/main/resource/webapp/WEB-INF/views/

application.yaml

```java
server:
	port: 8081
spring:
	mvc:
		view:
			prefix: /WEB-INF/views/
			suffix: .jsp
	jpa:
		show-sql: true
		hibernate:
			ddl-auto: create
		h2:
			console:
				enabled: true
		
			datasource:
				driver-class
```

controller/

- IndexController.java

```java
package com.kosa.security.controller;

import com.kosa.security.domain.User;
import com.kosa.security.repository.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.annotation.Secured;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.crypto.bcrypt.BCrypt;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.ResponseBody;

@Controller
public class IndexController {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private BCryptPasswordEncoder bCryptPasswordEncoder;

//    http://localhost:8081/common
    @GetMapping("/common")
    public String index() {
        return "index";
    }

//    http://localhost:8081/user
    @GetMapping("/user")
    public @ResponseBody String user() {
        return "user";
    }

    @GetMapping("/admin")
    public @ResponseBody String admin() {
        return "admin";
    }

    @GetMapping("/manager")
    public @ResponseBody String manager() {
        return "manager";
    }

    @GetMapping("/loginForm")
    public  String login() {
        return "loginForm";
    }

    @GetMapping("/joinForm")
    public String joinForm() {
        return "joinForm";
    }

    @PostMapping("/join")
    public String join(User user) {
        System.out.println(user);
        user.setRole("ROLE_USER");

        String rawPassword = user.getPassword();
        String encPassword = bCryptPasswordEncoder.encode(rawPassword);
        user.setPassword(encPassword);

        userRepository.save(user);
        return "redirect:/loginForm";
    }

    @GetMapping("/main")
    public String main() {
        return "main";
    }

    @Secured("ROLE_ADMIN")
    @GetMapping("/info")
    public @ResponseBody String info() {
        return "ê°œì¸ì •ë³´";
    }

    @PreAuthorize("hasRole('ROLE_MANAGER') or hasRole('ROLE_ADMIN')")
    @GetMapping("/data")
    public @ResponseBody String data() {
        return "ì¤‘ìš”í•œ ë°ì´í„°";
    }

}

```

views/

- index.jsp

```java
<%@ page language="java" contentType="text/html; charset=UTF-8"
         pageEncoding="UTF-8" %>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
</head>
<body>
<h1>Index Page</h1>
</body>
</html>
```

`http://localhost:8081/`

config/

- SecurityConfig.java

```java
package com.kosa.security.config;

import com.kosa.security.service.PrincipalOauth2UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.security.servlet.PathRequest;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.annotation.web.configurers.HeadersConfigurer;
import org.springframework.security.crypto.bcrypt.BCrypt;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;

//filter
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(securedEnabled = true, prePostEnabled = true)
public class SecurityConfig {
    @Autowired
    private PrincipalOauth2UserService principalOauth2UserService;

    @Bean
    public BCryptPasswordEncoder encoderPwd() {
        return new BCryptPasswordEncoder();
    }

    private static final String[] WHITE_LIST = {
            "common/**",
            "/WEB-INF/views/**",
            "/joinForm",
            "/loginForm",
            "/h2-console/**",
            "/join"
    };

    @Bean
    protected SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf(AbstractHttpConfigurer::disable);
        http.authorizeHttpRequests(authorize ->
                authorize.requestMatchers(WHITE_LIST).permitAll()
                        .requestMatchers("/manager/**").hasAnyRole("MANAGER", "ADMIN")
                        .requestMatchers("/admin/**").hasRole("ADMIN")
                        .anyRequest().authenticated()

                ).csrf(csrf ->
                        csrf.ignoringRequestMatchers(PathRequest.toH2Console()))
                .headers(headers ->
                        headers.frameOptions(HeadersConfigurer.FrameOptionsConfig::sameOrigin))
                .formLogin(form -> form
                        .loginPage("/loginForm")
                        .loginProcessingUrl("/login")
                        .defaultSuccessUrl("/main")
                ).oauth2Login(oath2Login ->
                        oath2Login.loginPage("/loginForm")
                            .userInfoEndpoint(userInfoEndpoint ->
                                    userInfoEndpoint.userService(principalOauth2UserService))
                )
                .logout(logout -> logout
                        .logoutUrl("/logout")
                        .logoutSuccessUrl("/loginForm")
                        .invalidateHttpSession(true)
                        .deleteCookies("JSESSIONID")
                );

        return http.build();
    }

}

```

- loginForm.jsp 

```java
<%@ page language="java" contentType="text/html; charset=UTF-8"
         pageEncoding="UTF-8" %>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
</head>
<body>
    <h1>ë¡œê·¸ì¸ í¼í˜ì´ì§€</h1>
    <hr>
    <form action="/login" method="post">
        <input type="text" name="username" placeholder="username"><br/>
        <input type="password" name="password" placeholder="password"><br/>
        <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
        <button>ë¡œê·¸ì¸</button>
    </form>
    <a href="/oauth2/authorization/google">êµ¬ê¸€ë¡œê·¸ì¸</a>
    <a href="/joinForm">íšŒì›ê°€ì…</a>
</body>
</html>
```

[http://localhost:8081/login](http://localhost:8081/loginForm) , admin, manager í•˜ë©´ ë¡œê·¸ì¸í¼ìœ¼ë¡œ ê°

domain/

- User.java

```java
package com.kosa.security.domain;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.hibernate.annotations.CreationTimestamp;
import org.springframework.data.annotation.CreatedDate;

import java.sql.Timestamp;

@Entity
@Table(name = "user2")
@AllArgsConstructor
@NoArgsConstructor
@Data
public class User {
    @Id
    @GeneratedValue
    private int id;
    private String username;
    private String password;
    private String email;
    private String role;
    @CreationTimestamp
    private Timestamp createDate;
}

```

- joinForm.jsp ë„£ìŒ
// loginì—ì„œ íšŒì›ê°€ì… ëˆ„ë¥´ë©´ ë„˜ì–´ê°

```java
<%@ page language="java" contentType="text/html; charset=UTF-8"
         pageEncoding="UTF-8" %>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
</head>
<body>
    <h1>íšŒì›ê°€ì…í¼</h1>
    <hr>
    <form action="/join" method="post">
        <input type="text" name="username"><br/>
        <input type="password" name="password"><br/>
        <input type="text" name="email"><br/>
        <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
        <button>íšŒì›ê°€ì…</button>
    </form>

</body>
</html>
```

repository/

- UserRepository.java(interface)

```java
package com.kosa.security.repository;

import com.kosa.security.domain.User;
import org.springframework.data.jpa.repository.JpaRepository;

//findByUsername(String username) ëŠ” JPAê°€ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•˜ëŠ” ë©”ì„œë“œëŠ” ì•„ë‹™ë‹ˆë‹¤,
//í•˜ì§€ë§Œ Spring Data JPAê°€ ë©”ì„œë“œ ì´ë¦„ì„ í•´ì„í•´ì„œ ìë™ìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ìƒì„±í•´ì¤ë‹ˆë‹¤.
//ì •ë¦¬í•˜ìë©´:JpaRepositoryì—ëŠ” findById, findAll, save, delete ë“± ê¸°ë³¸ ë©”ì„œë“œë§Œ ì¡´ì¬í•©ë‹ˆë‹¤.
//findByUsernameì€ usernameì´ë¼ëŠ” í•„ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê²€ìƒ‰í•˜ê³  ì‹¶ì„ ë•Œ ê°œë°œìê°€ ì§ì ‘ ì¸í„°í˜ì´ìŠ¤ì— ë©”ì„œë“œë¥¼ ì„ ì–¸í•´ ì£¼ëŠ” ê²ƒì…ë‹ˆë‹¤.
//ì„ ì–¸ë§Œ í•˜ë©´, Spring Data JPAê°€ ë©”ì„œë“œ ì´ë¦„ì„ íŒŒì‹±í•´ì„œ ì¿¼ë¦¬ë¥¼ ìë™ ìƒì„±í•´ ì¤ë‹ˆë‹¤
public interface UserRepository extends JpaRepository<User, Integer> {
    public User findByUsername(String username);

}

```

UserDetailsService - UserDetails

ğŸ“Œ ìš”ì•½

| í•­ëª© | ì„¤ëª… |
| --- | --- |
| `UserDetailsService` | ì‚¬ìš©ì ì •ë³´ë¥¼ `UserDetails` í˜•íƒœë¡œ ê°€ì ¸ì˜¤ëŠ” ë¡œì§ ì •ì˜ |
| `UserDetails` | ì¸ì¦ ì²˜ë¦¬ì— í•„ìš”í•œ ì‚¬ìš©ì ì •ë³´ ì œê³µ ê°ì²´ |

config/auth/

- PrincipalDetail.java

```java
package com.kosa.security.config.auth;

import com.kosa.security.domain.User;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import java.util.ArrayList;
import java.util.Collection;
import java.util.List;

//UserDetail ê°ì²´ë¥¼ ë§Œë“ ê±° í™•ì‹¤x
public class PrincipalDetail implements UserDetails {
    private User user;

    public PrincipalDetail(User user) {
        this.user = user;
    }

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        Collection<GrantedAuthority> collect = new ArrayList<GrantedAuthority>();
        collect.add(new GrantedAuthority() {
            @Override
            public String getAuthority() {
                return user.getRole();
            }
        });
        return collect;
    }

    @Override
    public String getPassword() {
        return user.getPassword();
    }

    @Override
    public String getUsername() {
        return user.getUsername();
    }

    @Override
    public boolean isAccountNonExpired() {
        return true;
    }

    @Override
    public boolean isAccountNonLocked() {
        return true;
    }

    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }

    @Override
    public boolean isEnabled() {
        return true;
    }
}

```

- UserRepository.java

```java
package com.kosa.security.repository;

import com.kosa.security.domain.User;
import org.springframework.data.jpa.repository.JpaRepository;

//findByUsername(String username) ëŠ” JPAê°€ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•˜ëŠ” ë©”ì„œë“œëŠ” ì•„ë‹™ë‹ˆë‹¤,
//í•˜ì§€ë§Œ Spring Data JPAê°€ ë©”ì„œë“œ ì´ë¦„ì„ í•´ì„í•´ì„œ ìë™ìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ìƒì„±í•´ì¤ë‹ˆë‹¤.
//ì •ë¦¬í•˜ìë©´:JpaRepositoryì—ëŠ” findById, findAll, save, delete ë“± ê¸°ë³¸ ë©”ì„œë“œë§Œ ì¡´ì¬í•©ë‹ˆë‹¤.
//findByUsernameì€ usernameì´ë¼ëŠ” í•„ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê²€ìƒ‰í•˜ê³  ì‹¶ì„ ë•Œ ê°œë°œìê°€ ì§ì ‘ ì¸í„°í˜ì´ìŠ¤ì— ë©”ì„œë“œë¥¼ ì„ ì–¸í•´ ì£¼ëŠ” ê²ƒì…ë‹ˆë‹¤.
//ì„ ì–¸ë§Œ í•˜ë©´, Spring Data JPAê°€ ë©”ì„œë“œ ì´ë¦„ì„ íŒŒì‹±í•´ì„œ ì¿¼ë¦¬ë¥¼ ìë™ ìƒì„±í•´ ì¤ë‹ˆë‹¤
public interface UserRepository extends JpaRepository<User, Integer> {
    public User findByUsername(String username);

}

```

service/

- PrincipalDetailService.java

```java
package com.kosa.security.service;

import com.kosa.security.config.auth.PrincipalDetail;
import com.kosa.security.domain.User;
import com.kosa.security.repository.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

//.loginProcessingUrl("/login")
// ë¡œê·¸ì¸ ìš”ì²­ì´ ì˜¤ë©´ loadUserByUsername() ìë™ìœ¼ë¡œ í˜¸ì¶œ
@Service
public class PrincipalDetailService implements UserDetailsService {
    @Autowired
    // ì‚¬ìš©ì ì •ë³´ë¥¼ DBì—ì„œ ì¡°íšŒí•˜ê¸° ìœ„í•œ ì˜ì¡´ì„± ì£¼ì…
    private UserRepository userRepository;

    /**
     * ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ ë¡œê·¸ì¸ ìš”ì²­ì„ ê°€ë¡œì±„ì„œ usernameì„ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê²¨ì¤„ ë•Œ
     * ì´ ë©”ì„œë“œê°€ ìë™ìœ¼ë¡œ í˜¸ì¶œë¨
     *
     * ì´ ë©”ì„œë“œëŠ” DBì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³ ,
     * í•´ë‹¹ ì •ë³´ë¥¼ ë‹´ì€ UserDetails êµ¬í˜„ì²´(PrincipalDetail)ë¥¼ ë°˜í™˜í•´ì•¼
     * ì´í›„ ë¹„ë°€ë²ˆí˜¸ ì²´í¬ ë“± ì¸ì¦ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•¨
     *
     * @param username ë¡œê·¸ì¸ í¼ì—ì„œ ì „ë‹¬ëœ ì‚¬ìš©ì ì´ë¦„ (ID)
     * @return UserDetails (PrincipalDetail ê°ì²´)
     * @throws UsernameNotFoundException ì‚¬ìš©ì ì •ë³´ê°€ ì—†ì„ ê²½ìš° ì˜ˆì™¸ ë°œìƒ
     */
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        User user = userRepository.findByUsername(username);
        // ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ë©´ PrincipalDetail(UserDetails êµ¬í˜„ì²´)ë¡œ ë˜í•‘í•˜ì—¬ ë°˜í™˜
        if (user != null) {
            return new PrincipalDetail(user);
        }
        return null;
    }
}

```

veiw/

- main.jsp

```java
<%@ page language="java" contentType="text/html; charset=UTF-8"
         pageEncoding="UTF-8" %>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
</head>
<body>
<h1>Main Page</h1>
<form action="/logout" method="post">
    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
    <button type="submit">Logout</button>
</form>
</body>
</html>
```

```java
aa 1234 aa@aa.com => ROLE_MANAGER
bb 1234 bb@bb.com => ROLE_ADMIN

update user2 set role='ROLE_MANAGER' where id=1;
update user2 set role='ROLE_ADMIN' where id=2;
commit;
```

- pom.xml

```xml
     <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-oauth2-client</artifactId>
        </dependency>
```

- application.yaml

```xml
#spring.application.name=security
server:
  port: 8081
spring:
  mvc:
    view:
      prefix: /WEB-INF/views/
      suffix: .jsp
  jpa:
    show-sql: true
    hibernate:
      ddl-auto: create
  h2:
    console:
      enabled: true

  datasource:
    driver-class-name: org.h2.Driver
    url: jdbc:h2:mem:testdb
    username: sa
    password:

  security:
    oauth2:
      client:
        registration:
          google:
           
          scope:
          - email
          - profile
```

service/

- PrincipalOauth2UserService.java

```java
package com.kosa.security.service;

import org.springframework.security.oauth2.client.userinfo.DefaultOAuth2UserService;
import org.springframework.security.oauth2.client.userinfo.OAuth2UserRequest;
import org.springframework.security.oauth2.core.OAuth2AuthenticationException;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.stereotype.Service;

@Service
public class PrincipalOauth2UserService extends DefaultOAuth2UserService {
    @Override
    public OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {
        System.out.println("userRequest : " + userRequest);
        System.out.println("getClientRegistration : "  + userRequest.getClientRegistration());
        System.out.println("getAccessToken : "  + userRequest.getAccessToken());
        System.out.println("getAttributes : "  + super.loadUser(userRequest).getAttributes());
        return super.loadUser(userRequest);
    }
}

```

- SecurityConfig.java

```java
package com.kosa.security.config;

import com.kosa.security.service.PrincipalOauth2UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.security.servlet.PathRequest;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.annotation.web.configurers.HeadersConfigurer;
import org.springframework.security.crypto.bcrypt.BCrypt;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;

//filter
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(securedEnabled = true, prePostEnabled = true)
public class SecurityConfig {
    @Autowired
    private PrincipalOauth2UserService principalOauth2UserService;

    @Bean
    public BCryptPasswordEncoder encoderPwd() {
        return new BCryptPasswordEncoder();
    }

    private static final String[] WHITE_LIST = {
            "common/**",
            "/WEB-INF/views/**",
            "/joinForm",
            "/loginForm",
            "/h2-console/**",
            "/join"
    };

    @Bean
    protected SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf(AbstractHttpConfigurer::disable);
        http.authorizeHttpRequests(authorize ->
                authorize.requestMatchers(WHITE_LIST).permitAll()
                        .requestMatchers("/manager/**").hasAnyRole("MANAGER", "ADMIN")
                        .requestMatchers("/admin/**").hasRole("ADMIN")
                        .anyRequest().authenticated()

                ).csrf(csrf ->
                        csrf.ignoringRequestMatchers(PathRequest.toH2Console()))
                .headers(headers ->
                        headers.frameOptions(HeadersConfigurer.FrameOptionsConfig::sameOrigin))
                .formLogin(form -> form
                        .loginPage("/loginForm")
                        .loginProcessingUrl("/login")
                        .defaultSuccessUrl("/main")
                ).oauth2Login(oath2Login ->
                        oath2Login.loginPage("/loginForm")
                            .userInfoEndpoint(userInfoEndpoint ->
                                    userInfoEndpoint.userService(principalOauth2UserService))
                )
                .logout(logout -> logout
                        .logoutUrl("/logout")
                        .logoutSuccessUrl("/loginForm")
                        .invalidateHttpSession(true)
                        .deleteCookies("JSESSIONID")
                );

        return http.build();
    }

}

```
