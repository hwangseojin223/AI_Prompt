## Validation

- pom.xml

```markdown
<!-- https://mvnrepository.com/artifact/org.hibernate.validator/hibernate-validator -->
<dependency>
    <groupId>org.hibernate.validator</groupId>
    <artifactId>hibernate-validator</artifactId>
    <version>8.0.2.Final</version>
</dependency>
```

- User.java

```java
package com.kosa.restapi.domain;

import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.persistence.*;
import jakarta.validation.constraints.Past;
import jakarta.validation.constraints.Size;
import jdk.jfr.Enabled;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.Date;

@Data
@AllArgsConstructor
@NoArgsConstructor
@JsonIgnoreProperties(value = {"password", "ssn"}) // í•œë²ˆì— í•˜ëŠ” ë²•
@Schema(description = "ì‚¬ìš©ì ìƒì„¸ ì •ë³´ë¥¼ ìœ„í•œ ë„ë©”ì¸ ê°ì²´")
public class User {
    @Schema(title = "ì‚¬ìš©ì ID", description = "ì‚¬ìš©ì IDëŠ” ìë™ ìƒì„±ë©ë‹ˆë‹¤.")
   
 
    private Integer id;

    @Schema(title = "ì‚¬ìš©ì ì´ë¦„", description = "ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.")
    @Size(min = 2, max = 20, message = "Nameì€ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
    private String name;
    @Past(message = "ë“±ë¡ì¸ì€ ë¯¸ë˜ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    private Date joinDate;

//    @JsonIgnore // ê°œë³„ë¡œ ì‚¬ìš©í•˜ëŠ” ë²•
//    http://localhost:8081/users ì—ì„œ password, ssnì€ ì¶œë ¥ì•ˆë¨
    private String password;
//    @JsonIgnore
    private String ssn;
}

```

- UserController.java

```java
package com.kosa.restapi.controller;

import com.kosa.restapi.domain.User;
import com.kosa.restapi.exception.UserNotFoundException;
import com.kosa.restapi.service.UserDaoService;
import jakarta.validation.Valid;
import org.springframework.hateoas.EntityModel;
import org.springframework.hateoas.server.mvc.WebMvcLinkBuilder;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.support.ServletUriComponentsBuilder;

import java.net.URI;
import java.util.List;
@RestController
public class UserController {
//    @Autowired
    private UserDaoService service ;

    public UserController(UserDaoService service) {
        this.service = service ;
    }

    @GetMapping("/users")
    public List<User> retrieveAllUser() {
        return service.findAll();
    }

    @GetMapping("/users/{id}")
    public EntityModel<User> retrieveUser(@PathVariable int id) {
        User user = service.findOne(id);

        if (user == null) {
            throw new UserNotFoundException(String.format("ID[%s] not found", id));
        }

        // ì‚¬ìš©ì ì •ë³´ë¥¼ EntityModelë¡œ ê°ì‹¸ê¸° (HATEOASë¥¼ ìœ„í•œ ì‘ì—…)
        EntityModel<User> model = EntityModel.of(user);
        // "ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ" APIë¡œ ê°€ëŠ” ë§í¬ ìƒì„±
        WebMvcLinkBuilder linkTo = WebMvcLinkBuilder
                .linkTo(WebMvcLinkBuilder.methodOn(this.getClass()).retrieveAllUser());
        // modelì— "all-users"ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë§í¬ ì¶”ê°€
        model.add(linkTo.withRel("all-users"));
        // ìµœì¢…ì ìœ¼ë¡œ ì‚¬ìš©ì ë°ì´í„° + ë§í¬ ì •ë³´ ë°˜í™˜
        return model;
    }

//    @PostMapping("/users")
//    public User createUser(@RequestBody User user) {
//        User savedUser = service.save(user);
//        return savedUser;
//    }
    // HTTP Status code ì œì–´
    @PostMapping("/users")
    public ResponseEntity<User> createUser(@Valid @RequestBody User user) {
        User savedUser = service.save(user);
        URI location = ServletUriComponentsBuilder.fromCurrentRequest()
                .path("/{id}")
                .buildAndExpand(savedUser.getId())
                .toUri();

        return ResponseEntity.created(location).build();
    }

    @DeleteMapping("/users/{id}")
    public void deleteUser(@PathVariable int id) {
        User user = service.deleteById(id);
        if (user == null) {
            throw new UserNotFoundException(String.format("ID[%s] not found", id));
        }
    }
}

```

- CustomizedResponseEntityExceptionHandler.java

```java
package com.kosa.restapi.exception;

import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.HttpStatusCode;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.context.request.WebRequest;
import org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler;

import java.util.Date;

// ì—ëŸ¬ë¥¼ í•¸ë“¤ë§ í•˜ê¸° ìœ„í•´ ìŠ¤í”„ë§ë¶€íŠ¸ì—ì„œ ì œê³µí•˜ëŠ” í´ë˜ìŠ¤
// ëª¨ë“  ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ì‹¤í–‰ì´ ë  ë–„ @ControllerAdvice ì˜ˆì™¸ë¥¼ ì „ë‹´í•´ì„œ ì²˜ë¦¬
@ControllerAdvice
public class CustomizedResponseEntityExceptionHandler extends ResponseEntityExceptionHandler {
    // ëª¨ë“  ì˜ˆì™¸ì²˜ë¦¬ë¥¼ ì²˜ë¦¬í•´ì£¼ëŠ” ë©”ì„œë“œ
    @ExceptionHandler(Exception.class)
    public final ResponseEntity<Object> handleAllExceptions(Exception ex, WebRequest request) {
        ExceptionResponse exceptionResponse = new ExceptionResponse(
                new Date(), ex.getMessage(), request.getDescription(false)
        );
        return new ResponseEntity<>(exceptionResponse, HttpStatus.INTERNAL_SERVER_ERROR);
    }

    @ExceptionHandler(UserNotFoundException.class)
    public final ResponseEntity<Object> handleUserNotFoundException(Exception ex, WebRequest request) {
        ExceptionResponse exceptionResponse = new ExceptionResponse(
                new Date(), ex.getMessage(), request.getDescription(false)
        );
        return new ResponseEntity<>(exceptionResponse, HttpStatus.NOT_FOUND);
    }

    @Override
    protected ResponseEntity<Object> handleMethodArgumentNotValid(MethodArgumentNotValidException ex,
                                                                  HttpHeaders headers,
                                                                  HttpStatusCode status,
                                                                  WebRequest request) {
        ExceptionResponse exceptionResponse = new ExceptionResponse(
                new Date(), "Validation Fail", ex.getBindingResult().toString()
        );

        return new ResponseEntity<>(exceptionResponse, HttpStatus.BAD_REQUEST);
    }
}

```

domain/

- [AdminUser.java](http://AdminUser.java) //user.java ì¹´í”¼

```java
package com.kosa.restapi.domain;

import com.fasterxml.jackson.annotation.JsonFilter;
import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import jakarta.validation.constraints.Past;
import jakarta.validation.constraints.Size;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.Date;

@Data
@AllArgsConstructor
@NoArgsConstructor
@JsonFilter("UserInfo")
public class AdminUser {
    private Integer id;
    @Size(min = 2, max = 20, message = "Nameì€ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
    private String name;
    @Past(message = "ë“±ë¡ì¸ì€ ë¯¸ë˜ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    private Date joinDate;

    private String password;
    private String ssn;
}

```

controller/

- [AdminUserController.java](http://AdminUserController.java) //usercontroller.javaì¹´í”¼

```java
package com.kosa.restapi.controller;

import com.fasterxml.jackson.databind.ser.FilterProvider;
import com.fasterxml.jackson.databind.ser.impl.SimpleBeanPropertyFilter;
import com.fasterxml.jackson.databind.ser.impl.SimpleFilterProvider;
import com.kosa.restapi.domain.AdminUser;
import com.kosa.restapi.domain.User;
import com.kosa.restapi.exception.UserNotFoundException;
import com.kosa.restapi.service.UserDaoService;
import jakarta.validation.Valid;
import org.springframework.beans.BeanUtils;
import org.springframework.http.ResponseEntity;
import org.springframework.http.converter.json.MappingJacksonValue;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.support.ServletUriComponentsBuilder;

import java.net.URI;
import java.util.ArrayList;
import java.util.List;

@RestController
@RequestMapping("/admin")
public class AdminUserController {
//    @Autowired
    private UserDaoService service ;

    public AdminUserController(UserDaoService service) {
        this.service = service ;
    }

    @GetMapping("/users")
    public MappingJacksonValue retrieveAllUsers() {
        List<User> users = service.findAll();
        List<AdminUser> adminUsers = new ArrayList<>();
        AdminUser adminUser = null;

        for (User user : users) {
            adminUser = new AdminUser();
            BeanUtils.copyProperties(user, adminUser);
            adminUsers.add(adminUser);
        }

        SimpleBeanPropertyFilter filter =
                SimpleBeanPropertyFilter.filterOutAllExcept("id", "name", "joinDate", "password", "ssn");
        FilterProvider filters = new SimpleFilterProvider().addFilter("UserInfo", filter);

        MappingJacksonValue mapping = new MappingJacksonValue(adminUsers);
        mapping.setFilters(filters);

        return mapping;
    }

    @GetMapping("/users/{id}")
    public MappingJacksonValue retrieveUser(@PathVariable int id) {
        User user = service.findOne(id);
        AdminUser adminUser = new AdminUser();

        if (user == null) {
            throw new UserNotFoundException(String.format("ID[%s] not found", id));
        }else{
            BeanUtils.copyProperties(user, adminUser);
        }

        SimpleBeanPropertyFilter filter =
                SimpleBeanPropertyFilter.filterOutAllExcept("id", "name", "joinDate", "ssn");
        FilterProvider filters = new SimpleFilterProvider().addFilter("UserInfo", filter);

        MappingJacksonValue mapping = new MappingJacksonValue(adminUser);
        mapping.setFilters(filters);

        return mapping;
    }

//    @PostMapping("/users")
//    public User createUser(@RequestBody User user) {
//        User savedUser = service.save(user);
//        return savedUser;
//    }
    // HTTP Status code ì œì–´
    @PostMapping("/users")
    public ResponseEntity<User> createUser(@Valid @RequestBody User user) {
        User savedUser = service.save(user);
        URI location = ServletUriComponentsBuilder.fromCurrentRequest()
                .path("/{id}")
                .buildAndExpand(savedUser.getId())
                .toUri();

        return ResponseEntity.created(location).build();
    }

    @DeleteMapping("/users/{id}")
    public void deleteUser(@PathVariable int id) {
        User user = service.deleteById(id);
        if (user == null) {
            throw new UserNotFoundException(String.format("ID[%s] not found", id));
        }
    }
}

```

## HATEOAS

**H**ypermedia **A**s **T**he **E**ngine **O**f **A**pplication **S**tate

â¡ï¸ **í•˜ì´í¼ë¯¸ë””ì–´ë¥¼ í†µí•´ ë‹¤ìŒ í–‰ë™ì„ ì•ˆë‚´í•˜ëŠ” REST API ì„¤ê³„ ë°©ë²•**

ğŸ“– ì‰½ê²Œ ë§í•˜ë©´

- í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ ì‘ë‹µì„ ë°›ìœ¼ë©´
- **ê·¸ ë°ì´í„° ì•ˆì— "ë‹¤ìŒì— ë­˜ í•  ìˆ˜ ìˆëŠ”ì§€" ë§í¬**ë¥¼ ê°™ì´ ì£¼ëŠ” ê±°

ì¦‰, "ë‹¨ìˆœíˆ ë°ì´í„°ë§Œ ì£¼ëŠ” ê²Œ ì•„ë‹ˆë¼ â†’ ë‹¤ìŒ ê°€ëŠ¥í•œ í–‰ë™ê¹Œì§€ ì•Œë ¤ì£¼ëŠ” ê²ƒ."

ğŸ“š ì˜ˆì‹œë¡œ ë‹¤ ê°™ì´ ë³´ë©´

```json
json
ë³µì‚¬í¸ì§‘
{
  "id": 1,
  "name": "í™ê¸¸ë™",
  "_links": {
    "self": { "href": "/users/1" },
    "update": { "href": "/users/1/update" },
    "delete": { "href": "/users/1/delete" }
  },
  "_embedded": {
    "orders": [
      { "id": 101, "item": "ì±…" },
      { "id": 102, "item": "ë…¸íŠ¸ë¶" }
    ]
  }
}

```

ğŸ‘‰ ì •ë¦¬í•˜ë©´

- ì´ ì‘ë‹µì€ `í™ê¸¸ë™`ì´ë¼ëŠ” ìœ ì €ì— ëŒ€í•œ ë°ì´í„°ê³ 
- `_links`ë¥¼ í†µí•´ **ìˆ˜ì •/ì‚­ì œ** ë§í¬ë¥¼ ì•ˆë‚´í•´ì£¼ê³ 
- `_embedded`ë¥¼ í†µí•´ **í™ê¸¸ë™ì˜ ì£¼ë¬¸ ëª©ë¡**ë„ ê°™ì´ ë‚´ë ¤ì£¼ê³  ìˆì–´.

---

âœ¨ ì´ˆê°„ë‹¨ ìš”ì•½

| ì´ë¦„ | ëœ» | ëª©ì  |
| --- | --- | --- |
| `_links` | ê´€ë ¨ëœ ë§í¬ ëª¨ìŒ | ë‹¤ìŒì— í•  ìˆ˜ ìˆëŠ” í–‰ë™ ì•ˆë‚´ |
| `_embedded` | ì•ˆì— ë‹¤ë¥¸ ë¦¬ì†ŒìŠ¤ë¥¼ í¬í•¨ | ì¶”ê°€ ë°ì´í„° ë°”ë¡œ ì œê³µ |
| `self` | ìì‹ ì„ ê°€ë¦¬í‚¤ëŠ” ë§í¬ | ë¦¬ì†ŒìŠ¤ ìì‹ ì˜ URL ì•Œë ¤ì¤Œ |

- pom.xml

```markdown
<dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-hateoas</artifactId>
        </dependency>
```

- UserController.java

```java
package com.kosa.restapi.controller;

import com.kosa.restapi.domain.User;
import com.kosa.restapi.exception.UserNotFoundException;
import com.kosa.restapi.service.UserDaoService;
import jakarta.validation.Valid;
import org.springframework.hateoas.EntityModel;
import org.springframework.hateoas.server.mvc.WebMvcLinkBuilder;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.support.ServletUriComponentsBuilder;

import java.net.URI;
import java.util.List;
@RestController
public class UserController {
//    @Autowired
    private UserDaoService service ;

    public UserController(UserDaoService service) {
        this.service = service ;
    }

    @GetMapping("/users")
    public List<User> retrieveAllUser() {
        return service.findAll();
    }

    @GetMapping("/users/{id}")
    public EntityModel<User> retrieveUser(@PathVariable int id) {
        User user = service.findOne(id);

        if (user == null) {
            throw new UserNotFoundException(String.format("ID[%s] not found", id));
        }

        // ì‚¬ìš©ì ì •ë³´ë¥¼ EntityModelë¡œ ê°ì‹¸ê¸° (HATEOASë¥¼ ìœ„í•œ ì‘ì—…)
        EntityModel<User> model = EntityModel.of(user);
        // "ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ" APIë¡œ ê°€ëŠ” ë§í¬ ìƒì„±
        WebMvcLinkBuilder linkTo = WebMvcLinkBuilder
                .linkTo(WebMvcLinkBuilder.methodOn(this.getClass()).retrieveAllUser());
        // modelì— "all-users"ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë§í¬ ì¶”ê°€
        model.add(linkTo.withRel("all-users"));
        // ìµœì¢…ì ìœ¼ë¡œ ì‚¬ìš©ì ë°ì´í„° + ë§í¬ ì •ë³´ ë°˜í™˜
        return model;
    }

//    @PostMapping("/users")
//    public User createUser(@RequestBody User user) {
//        User savedUser = service.save(user);
//        return savedUser;
//    }
    // HTTP Status code ì œì–´
    @PostMapping("/users")
    public ResponseEntity<User> createUser(@Valid @RequestBody User user) {
        User savedUser = service.save(user);
        URI location = ServletUriComponentsBuilder.fromCurrentRequest()
                .path("/{id}")
                .buildAndExpand(savedUser.getId())
                .toUri();

        return ResponseEntity.created(location).build();
    }

    @DeleteMapping("/users/{id}")
    public void deleteUser(@PathVariable int id) {
        User user = service.deleteById(id);
        if (user == null) {
            throw new UserNotFoundException(String.format("ID[%s] not found", id));
        }
    }
}

```

## swagger

- pom.xml

```markdown
<dependency>
            <groupId>org.springdoc</groupId>
            <artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
            <version>2.8.6</version>
        </dependency>
```

http://localhost:8081/swagger-ui/index.html â†’ chrome ìœ¼ë¡œ 

- User.java

```java
package com.kosa.restapi.domain;

import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.persistence.Entity;
import jakarta.validation.constraints.Past;
import jakarta.validation.constraints.Size;
import jdk.jfr.Enabled;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.Date;

@Data
@AllArgsConstructor
@NoArgsConstructor
@JsonIgnoreProperties(value = {"password", "ssn"}) // í•œë²ˆì— í•˜ëŠ” ë²•
@Schema(description = "ì‚¬ìš©ì ìƒì„¸ ì •ë³´ë¥¼ ìœ„í•œ ë„ë©”ì¸ ê°ì²´")
public class User {
    @Schema(title = "ì‚¬ìš©ì ID", description = "ì‚¬ìš©ì IDëŠ” ìë™ ìƒì„±ë©ë‹ˆë‹¤.")
    private Integer id;

    @Schema(title = "ì‚¬ìš©ì ì´ë¦„", description = "ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.")
    @Size(min = 2, max = 20, message = "Nameì€ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
    private String name;
    @Past(message = "ë“±ë¡ì¸ì€ ë¯¸ë˜ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    private Date joinDate;

//    @JsonIgnore // ê°œë³„ë¡œ ì‚¬ìš©í•˜ëŠ” ë²•
//    http://localhost:8081/users ì—ì„œ password, ssnì€ ì¶œë ¥ì•ˆë¨
    private String password;
//    @JsonIgnore
    private String ssn;
}

```


# JPA

ğŸ“˜ **ORM (Object-Relational Mapping)**

=**"ê°ì²´"** (Java í´ë˜ìŠ¤) â†” **"ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤"**(RDB) **ìë™ ë³€í™˜í•´ì£¼ëŠ” ê¸°ìˆ **

ORM ì¥ì 
- ìƒì‚°ì„± : ë§¤í•‘ì„ í•˜ë©´ ë°ì´í„° ì…ì¶œë ¥ì´ ì •ë§ ì‰¬ì›Œì§„ë‹¤.
- ìœ ì§€ë³´ìˆ˜ì„± : ì½”ë“œê°€ êµ‰ì¥íˆ ê°„ê²°í•´ì§€ê³ , ì½”ë“œëŸ‰ì´ ì¤„ì–´ ìœ ì§€ë³´ìˆ˜ì„±ì´ ë†’ì•„ì§„ë‹¤.
- ì„±ëŠ¥ : ê°ì²´ì™€ í…Œì´ë¸” ì‚¬ì´ì— ìºì‹œê°€ ì¡´ì¬í•˜ì—¬ ì¤‘ë³µ í˜¹ì€ í•„ìš”ì—†ëŠ” ë°ì´í„° ë³€ê²½ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´

ë°˜ì˜í•˜ì§€ ì•Šê³ , ë°ì´í„°ê°€ ë³€ê²½ë  ì—¬ì§€ê°€ ìˆì„ ë•Œë§Œ ë³€ê²½ í•¨ìœ¼ë¡œ íš¨ìœ¨ì ì´ë‹¤.

- ë²¤ë” ë…ë¦½ì„± : Hibernateê°€ ì–´ë– í•œ ë°ì´í„°ë² ì´ìŠ¤ì— ë§ê²Œ SQLì„ ìë™ìœ¼ë¡œ ìƒì„± í•¨ìœ¼ë¡œ DBMS
ì— ë…ë¦½ì ì´ë‹¤.

ORM ë‹¨ì 
- ë†’ì€ í•™ìŠµë¹„ìš© : SQL, Hibernate,JPA ì „ë¶€ ì˜ ì•Œê³  ìˆì–´ì•¼ ì œëŒ€ë¡œ í™œìš©í•  ìˆ˜ ìˆê¸°ì— í•™ìŠµí•˜ëŠ”
ë° ë†’ì€ ë‚œì´ë„ì™€ ë§ì€ ì‹œê°„ì´ ì†Œìš”ëœë‹¤.
- íŠ¹ì • ë°ì´í„°ë² ì´ìŠ¤ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.(ì˜¤ë¼í´ í•¨ìˆ˜, íŠœë‹ê¸°ëŠ¥)
- ê°ì²´ì§€í–¥ ì„¤ê³„ê°€ í•„ìš”í•˜ë‹¤.

ğŸ“˜ JPAë€?

**JPA (Java Persistence API)** ="**ORM í‘œì¤€ ëª…ì„¸**"

ê¸ˆìœµì—ì„œ ì“¸ ìˆ˜ ì—†ìŒ

ì‰½ê²Œ ë§í•˜ë©´:

> "ìë°”ì—ì„œ ORM ì“¸ ë•Œ ì´ë ‡ê²Œ í•´ë¼" í•˜ê³  ê·œì¹™ë§Œ ì •í•´ë†“ì€ ê±°
> 

ğŸ§  ì •ë¦¬

| ì´ë¦„ | ì„¤ëª… | ì˜ˆì‹œ |
| --- | --- | --- |
| ORM | ê°ì²´ë¥¼ í…Œì´ë¸”ì— ë§¤í•‘í•˜ëŠ” ê¸°ìˆ  | Hibernate, MyBatis |
| JPA | ìë°”ìš© ORM í‘œì¤€ API | EntityManager, Repository |

mybatis ì™€ jpa ë‘˜ ë‹¤ ì•Œì•„ë¼ ë‘ê°œë¹„êµí•´ë³´ê¸°**

https://www.elancer.co.kr/blog/detail/231

| **í•­ëª©** | **ì„¤ëª…** | **ì˜ˆì‹œ** |
| --- | --- | --- |
| **@Entity** | í´ë˜ìŠ¤ê°€ JPA ì—”í‹°í‹°ì„ì„ ë‚˜íƒ€ë‚´ëŠ” ì–´ë…¸í…Œì´ì…˜. ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì— ë§¤í•‘ë¨. | `@Entity public class Account { ... }` |
| **@Id** | ì—”í‹°í‹° í´ë˜ìŠ¤ì˜ ê¸°ë³¸ í‚¤ë¥¼ ì§€ì •í•˜ëŠ” ì–´ë…¸í…Œì´ì…˜. | `@Id private Long id;` |
| **@GeneratedValue** | ê¸°ë³¸ í‚¤ ìƒì„± ì „ëµì„ ì„¤ì •í•˜ëŠ” ì–´ë…¸í…Œì´ì…˜. | `@GeneratedValue(strategy = GenerationType.IDENTITY)` |
| **@Table** | ì—”í‹°í‹° í´ë˜ìŠ¤ê°€ ë§¤í•‘ë˜ëŠ” í…Œì´ë¸”ì˜ ì´ë¦„ì„ ì§€ì •í•˜ëŠ” ì–´ë…¸í…Œì´ì…˜. ê¸°ë³¸ì ìœ¼ë¡œ í´ë˜ìŠ¤ëª…ì´ í…Œì´ë¸” ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©ë¨. | `@Table(name = "accounts")` |
| **ê¸°ë³¸ ìƒì„±ì** | ì—”í‹°í‹° í´ë˜ìŠ¤ëŠ” ë°˜ë“œì‹œ ê¸°ë³¸ ìƒì„±ìë¥¼ ê°€ì ¸ì•¼ í•˜ë©°, ë³´í†µ `public` ë˜ëŠ” `protected`ë¡œ ì„ ì–¸ë¨. | `public Account() {}` |
| **@OneToMany** | **1:N ê´€ê³„**ì—ì„œ í•˜ë‚˜ì˜ ì—”í‹°í‹°ê°€ ë‹¤ë¥¸ ì—¬ëŸ¬ ì—”í‹°í‹°ë¥¼ ì°¸ì¡°í•˜ëŠ” ê²½ìš° ì‚¬ìš©. | `@OneToMany(mappedBy = "account") private List<Transaction> transactions;` |
| **@ManyToOne** | **N:1 ê´€ê³„**ì—ì„œ ì—¬ëŸ¬ ì—”í‹°í‹°ê°€ í•˜ë‚˜ì˜ ì—”í‹°í‹°ë¥¼ ì°¸ì¡°í•˜ëŠ” ê²½ìš° ì‚¬ìš©. | `@ManyToOne private Account account;` |
| **@ManyToMany** | **N:M ê´€ê³„**ì—ì„œ ë‘ ì—”í‹°í‹°ê°€ ì„œë¡œ ì—¬ëŸ¬ ê°œì”© ì°¸ì¡°í•˜ëŠ” ê²½ìš° ì‚¬ìš©. | `@ManyToMany private Set<Product> products;` |
| **@Embeddable** | ë‹¤ë¥¸ ì—”í‹°í‹° í´ë˜ìŠ¤ì— ë‚´ì¥ë  ìˆ˜ ìˆëŠ” í´ë˜ìŠ¤ë¥¼ ì •ì˜í•˜ëŠ” ì–´ë…¸í…Œì´ì…˜. | `@Embeddable public class Address { ... }` |
| **@Embedded** | ì—”í‹°í‹° í´ë˜ìŠ¤ ë‚´ì— ë‚´ì¥ëœ ê°ì²´ë¥¼ ì§€ì •í•˜ëŠ” ì–´ë…¸í…Œì´ì…˜. | `@Embedded private Address address;` |

- application.yaml

```java
server:
  port: 8081

spring:
  datasource:
    url: jdbc:h2:mem:testdb
    username: sa
  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true
    defer-datasource-initialization: true
  h2:
    console:
      enabled: true
      settings:
        web-allow-others: true
```

**H2 Database**ëŠ” **Java** ê¸°ë°˜ì˜ ê²½ëŸ‰í˜• **ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ ì‹œìŠ¤í…œ(RDBMS)**ìœ¼ë¡œ, ê°œë°œ ë° í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ë§¤ìš° ìì£¼ ì‚¬ìš©ë©ë‹ˆë‹¤. H2ëŠ” **In-memory DB**ë¡œ ì‚¬ìš©ë  ìˆ˜ ìˆìœ¼ë©°, ë³„ë„ì˜ ì„œë²„ ì„¤ì¹˜ ì—†ì´ **ì„ë² ë””ë“œ ë°©ì‹**ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ ë¹ ë¥´ê³  íš¨ìœ¨ì ì¸ ë°ì´í„°ë² ì´ìŠ¤ ì†”ë£¨ì…˜ì„ ì œê³µí•©ë‹ˆë‹¤.

### H2 Database íŠ¹ì§•

1. **In-Memory Database**: ë©”ëª¨ë¦¬ì—ì„œë§Œ ì‘ë™í•˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ë¡œ, ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì¢…ë£Œë˜ë©´ ë°ì´í„°ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ë° ê°œë°œ í™˜ê²½ì„ ì œê³µí•©ë‹ˆë‹¤.
2. **ì„ë² ë””ë“œ ë° ì„œë²„ ëª¨ë“œ ì§€ì›**: H2ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë‚´ë¶€ì— ë‚´ì¥ë˜ì–´ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë©°, ì„œë²„ ëª¨ë“œë¡œë„ ì‘ë™í•  ìˆ˜ ìˆì–´ ë‹¤ë¥¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œë„ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3. **SQL í‘œì¤€ ì¤€ìˆ˜**: H2ëŠ” SQL í‘œì¤€ì„ ì¤€ìˆ˜í•˜ë©°, **MySQL**, **PostgreSQL**, **Oracle**ê³¼ ìœ ì‚¬í•œ SQL ë¬¸ë²•ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
4. **Javaì™€ì˜ í˜¸í™˜ì„±**: Java ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ì˜ í†µí•©ì´ ë§¤ìš° ì‰½ê³ , JDBCë¥¼ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
5. **ì›¹ ì½˜ì†” ì œê³µ**: ë‚´ì¥ëœ ì›¹ ì½˜ì†”ì„ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ê´€ë¦¬í•˜ê³  ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

http://localhost:8081/h2-console

- User.java

```java
package com.kosa.restapi.domain;

import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.persistence.*;
import jakarta.validation.constraints.Past;
import jakarta.validation.constraints.Size;
import jdk.jfr.Enabled;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.Date;
@Entity
@Table(name="users")// ì•ˆì¨ì£¼ë©´ Userê°€ í…Œì´ë¸” ì´ë¦„ì´ ëœë‹¤.
@Data
@AllArgsConstructor
@NoArgsConstructor
@JsonIgnoreProperties(value = {"password", "ssn"}) // í•œë²ˆì— í•˜ëŠ” ë²•
@Schema(description = "ì‚¬ìš©ì ìƒì„¸ ì •ë³´ë¥¼ ìœ„í•œ ë„ë©”ì¸ ê°ì²´")
public class User {
    @Schema(title = "ì‚¬ìš©ì ID", description = "ì‚¬ìš©ì IDëŠ” ìë™ ìƒì„±ë©ë‹ˆë‹¤.")
    @Id
    @GeneratedValue
    private Integer id;

    @Schema(title = "ì‚¬ìš©ì ì´ë¦„", description = "ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.")
    @Size(min = 2, max = 20, message = "Nameì€ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
    private String name;
    @Past(message = "ë“±ë¡ì¸ì€ ë¯¸ë˜ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    private Date joinDate;

//    @JsonIgnore // ê°œë³„ë¡œ ì‚¬ìš©í•˜ëŠ” ë²•
//    http://localhost:8081/users ì—ì„œ password, ssnì€ ì¶œë ¥ì•ˆë¨
    private String password;
//    @JsonIgnore
    private String ssn;
}

```

resources/

- data.sql

```sql
insert into users(id, join_date, name, password, ssn)
    values (9001, now(), 'user1', 'test1', '701010-1111111');
insert into users(id, join_date, name, password, ssn)
    values (9002, now(), 'user2', 'test2', '801010-1111111');
insert into users(id, join_date, name, password, ssn)
    values (9003, now(), 'user3', 'test3', '901010-1111111');
```

com.kosa.restapi.repository/

- UserRepository.java(interface)

```java
package com.kosa.restapi.repository;

import com.kosa.restapi.domain.User;
import org.springframework.data.jpa.repository.JpaRepository;

// ctrl í•˜ê³  JapReopositoryí´ë¦­í•˜ë©´ ì´ë™í•¨
public interface UserRepository extends JpaRepository<User, Integer> {

}
```

controller/

- UserJpaController.java

```java
package com.kosa.restapi.controller;

import com.kosa.restapi.domain.User;
import com.kosa.restapi.exception.UserNotFoundException;
import com.kosa.restapi.repository.UserRepository;
import jakarta.validation.Valid;
import org.springframework.hateoas.EntityModel;
import org.springframework.hateoas.server.mvc.WebMvcLinkBuilder;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.support.ServletUriComponentsBuilder;

import java.net.URI;
import java.util.List;
import java.util.Optional;

@RestController
@RequestMapping("/jpa")
public class UserJpaController {
    private UserRepository userRepository;

    public UserJpaController(UserRepository userRepository) {
        this.userRepository = userRepository;
    }

//    http://localhost:8081/jpa/users
    @GetMapping("/users")
    public List<User> retrieveAllUsers() {
        return userRepository.findAll();
    }

//    http://localhost:8081/jpa/users/9001
    @GetMapping("/users/{id}")
    public EntityModel<User> retrieveUser(@PathVariable int id) {
        // IDë¡œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ (Optional<User> íƒ€ì…ìœ¼ë¡œ ë°˜í™˜ë¨)
        Optional<User> user = userRepository.findById(id); // Optional ê°ì²´ë¡œ ë„˜ì–´ì˜´ ê·¸ê±¸ ìºìŠ¤íŒ…í•¨
        // ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì˜ˆì™¸ ë°œìƒ
        if (!user.isPresent()) {
            throw new UserNotFoundException("id-"+id);
        }
        // Optional ê°ì²´ì—ì„œ ì‹¤ì œ User ê°ì²´ë¥¼ êº¼ëƒ„
        EntityModel<User> model = EntityModel.of(user.get()); // optional ê°ì²´ë¡œ ë¶€í„° user ê°ì²´ë¥¼ ë½‘ì•„ëƒ„
        // "ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ" APIë¡œ ê°€ëŠ” ë§í¬ ìƒì„±
        WebMvcLinkBuilder linkTo = WebMvcLinkBuilder
                .linkTo(WebMvcLinkBuilder.methodOn(this.getClass()).retrieveAllUsers());
        // modelì— "all-users"ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë§í¬ ì¶”ê°€
        model.add(linkTo.withRel("all-users"));
        // ìµœì¢…ì ìœ¼ë¡œ ì‚¬ìš©ì ë°ì´í„° + ë§í¬ ì •ë³´ ë°˜í™˜
        return model;
    }

//    http://localhost:8081/jpa/users/9001
    @DeleteMapping("/users/{id}")
    public void deleteUser(@PathVariable int id) {
        userRepository.deleteById(id);
    }

    @PostMapping("/users")
    public ResponseEntity<User> createUser(@Valid @RequestBody User user) {
        User savedUser = userRepository.save(user);
        URI location = ServletUriComponentsBuilder.fromCurrentRequest()
                .path("/{id}")
                .buildAndExpand(savedUser.getId())
                .toUri();

        return ResponseEntity.created(location).build();
    }
}
```
